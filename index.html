<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Planificação Semanal - 1º Ciclo</title>
<!-- Firebase v8 (compat style usado no teu projecto) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<style>
  /* (mantive o teu CSS com pequenas alterações visuais) */
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fb;color:#222}
  .container{max-width:1200px;margin:20px auto;padding:18px}
  .card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:16px}
  h1{margin-bottom:10px;color:#2b3650}
  input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:8px}
  button{cursor:pointer;background:linear-gradient(90deg,#4f6ef7,#7b4be2);color:#fff;border:none}
  .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
  .turma-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:#f7f9ff;border-left:4px solid #4f6ef7;margin-bottom:8px}
  .turma-actions button{width:auto;padding:6px 10px;margin-left:8px}
  .hidden{display:none!important}
  .muted{color:#6b7280;font-size:13px}
  .notice{padding:8px;background:#fff4e5;border:1px solid #ffd6a5;border-radius:8px;margin-bottom:12px}
  .danger{background:#ffecee;border:1px solid #ffb7c5}
  textarea{min-height:80px}
  .schedule-table{width:100%;border-collapse:collapse}
  .schedule-table th,.schedule-table td{border:1px solid #e6e6e6;padding:6px;vertical-align:top}
  .time-cell{background:#4f6ef7;color:#fff;font-weight:700;width:140px;text-align:center}
  .content-cell textarea{width:100%;height:100%;border:0;background:transparent;resize:none}
</style>
</head>
<body>
<div class="container">
  <div id="authContainer" class="card">
    <h1>Planificação Escolar — Autenticação</h1>
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <button onclick="mostrarForm('login')" id="tabLogin" style="flex:1;background:#4f6ef7;color:#fff">Entrar</button>
      <button onclick="mostrarForm('register')" id="tabRegister" style="flex:1;background:#eee;color:#333">Registar</button>
    </div>

    <div id="errorMessage" class="notice danger hidden"></div>
    <div id="successMessage" class="notice hidden"></div>

    <form id="loginForm" style="margin-top:12px">
      <input id="loginEmail" type="email" placeholder="Email" required>
      <input id="loginPassword" type="password" placeholder="Palavra-passe" required>
      <button type="submit">Entrar</button>
    </form>

    <form id="registerForm" class="hidden" style="margin-top:12px">
      <input id="registerName" type="text" placeholder="Nome completo" required>
      <input id="registerEmail" type="email" placeholder="Email" required>
      <input id="registerPassword" type="password" placeholder="Palavra-passe (min 6)" required>
      <button type="submit">Registar</button>
    </form>

    <p class="muted" style="margin-top:12px">Se a tua conta existir mas o Firestore devolver erros de permissões, o aplicativo vai passar para modo local (dados guardados no browser).</p>
  </div>

  <div id="mainContent" class="hidden">
    <div class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>Planificação Semanal — 1.º Ciclo</h1>
        <div class="muted">Utilizador: <span id="userNameDisplay"></span></div>
      </div>
      <div style="text-align:right">
        <div id="modeIndicator" class="muted">Modo: <strong id="modeText">cloud</strong></div>
        <button onclick="logout()" style="margin-top:8px;background:#ef4444">Sair</button>
      </div>
    </div>

    <div class="row">
      <!-- criar turma -->
      <div class="card">
        <h3>Nova Turma</h3>
        <input id="nomeTurma" placeholder="Nome da turma (ex.: 4.º A)">
        <input id="anoLetivo" placeholder="Ano letivo (ex.: 2024/2025)">
        <input id="nomeProfessor" placeholder="Professor responsável (nome)">
        <button id="btnCriarTurma">Criar Turma</button>
      </div>

      <!-- lista turmas -->
      <div class="card">
        <h3>Turmas</h3>
        <div id="listaTurmas" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- semanas e calendário -->
    <div id="cardSemana" class="card hidden">
      <h3>Semanas (turma selecionada: <span id="turmaSelecionadaNome"></span>)</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
        <button onclick="criarSemanaRapida('esta')">Esta semana</button>
        <button onclick="criarSemanaRapida('proxima')">Próxima semana</button>
        <button onclick="criarSemanaRapida('custom')">Escolher no calendário</button>
      </div>

      <div id="calendarContainer" class="card hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div id="calendarTitle" class="muted"></div>
          <div>
            <button onclick="changeMonth(-1)">‹</button>
            <button onclick="changeMonth(1)">›</button>
          </div>
        </div>
        <div id="calendarGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px"></div>
      </div>

      <div id="selectedWeek" class="card hidden" style="margin-top:10px">
        <div>Semana selecionada: <span id="weekRangeText"></span></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="btnConfirmWeek">Criar esta semana</button>
        </div>
      </div>

      <div style="margin-top:16px">
        <h4>Semanas criadas</h4>
        <div id="listaSemanas" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- area planificacao -->
    <div id="areaPlanificacao" class="card hidden" style="margin-top:18px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <h3 id="tituloAtual">Planificação</h3>
          <div class="muted" id="infoAtual"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button onclick="mostrarSemanaCompleta()">Semana completa</button>
          <button onclick="mostrarDia('segunda')">2ª</button>
          <button onclick="mostrarDia('terca')">3ª</button>
          <button onclick="mostrarDia('quarta')">4ª</button>
          <button onclick="mostrarDia('quinta')">5ª</button>
          <button onclick="mostrarDia('sexta')">6ª</button>
          <button onclick="salvarPlanificacao()" style="background:#10b981">Guardar</button>
        </div>
      </div>

      <div class="schedule-container">
        <table class="schedule-table">
          <thead>
            <tr>
              <th>Horas</th>
              <th data-day="segunda" class="day-header">2ª feira</th>
              <th data-day="terca" class="day-header">3ª feira</th>
              <th data-day="quarta" class="day-header">4ª feira</th>
              <th data-day="quinta" class="day-header">5ª feira</th>
              <th data-day="sexta" class="day-header">6ª feira</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="time-cell">9h00–10h30</td>
              <td class="content-cell day-cell" data-day="segunda" data-time="0900-1030"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="terca" data-time="0900-1030"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="quarta" data-time="0900-1030"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="quinta" data-time="0900-1030"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="sexta" data-time="0900-1030"><textarea></textarea></td>
            </tr>
            <tr>
              <td class="time-cell">11h00–12h30</td>
              <td class="content-cell day-cell" data-day="segunda" data-time="1100-1230"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="terca" data-time="1100-1230"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="quarta" data-time="1100-1230"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="quinta" data-time="1100-1230"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="sexta" data-time="1100-1230"><textarea></textarea></td>
            </tr>
            <tr>
              <td class="time-cell">13h45–15h30</td>
              <td class="content-cell day-cell" data-day="segunda" data-time="1345-1530"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="terca" data-time="1345-1530"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="quarta" data-time="1345-1530"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="quinta" data-time="1345-1530"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="sexta" data-time="1345-1530"><textarea></textarea></td>
            </tr>
            <tr>
              <td class="time-cell">16h00–17h15</td>
              <td class="content-cell day-cell" data-day="segunda" data-time="1600-1715"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="terca" data-time="1600-1715"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="quarta" data-time="1600-1715"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="quinta" data-time="1600-1715"><textarea></textarea></td>
              <td class="content-cell day-cell" data-day="sexta" data-time="1600-1715"><textarea></textarea></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
/* ---------------------------
   Configuração Firebase
   (mantive a tua config)
   --------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAC9EguGeZd50W1jADEx73aJKGacFeGk9o",
  authDomain: "bddespesas.firebaseapp.com",
  projectId: "bddespesas",
  storageBucket: "bddespesas.firebasestorage.app",
  messagingSenderId: "521648200265",
  appId: "1:521648200265:web:82fc2c97f02e185478fd98",
  measurementId: "G-P7NX1T9RVE"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ---------------------------
   Estado da app
   --------------------------- */
let currentUser = null;
let turmaAtiva = null;        // { id, nome, ano, professor, isLocal }
let semanaAtiva = null;       // { id, descricao, isLocal }
let selectedWeekStart = null;
let selectedWeekEnd = null;
let calendarDate = new Date();
let localFallback = false;    // se true => trabalhar em localStorage

/* ---------------------------
   Helpers localStorage
   --------------------------- */
function getLocalTurmas(){ return JSON.parse(localStorage.getItem('local_turmas')||'[]'); }
function saveLocalTurmas(arr){ localStorage.setItem('local_turmas', JSON.stringify(arr)); }
function getLocalSemanas(){ return JSON.parse(localStorage.getItem('local_semanas')||'[]'); }
function saveLocalSemanas(arr){ localStorage.setItem('local_semanas', JSON.stringify(arr)); }

/* ---------------------------
   UI utilitários
   --------------------------- */
function showError(msg){ const el=document.getElementById('errorMessage'); el.textContent = msg; el.classList.remove('hidden'); }
function showSuccess(msg){ const el=document.getElementById('successMessage'); el.textContent = msg; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),3000); }
function clearMessages(){ document.getElementById('errorMessage').classList.add('hidden'); document.getElementById('successMessage').classList.add('hidden'); }

/* Indica modo (cloud/local) */
function setModeIndicator(){
  document.getElementById('modeText').textContent = localFallback ? 'local' : 'cloud';
}

/* ---------------------------
   Autenticação
   --------------------------- */
function mostrarForm(tipo){
  clearMessages();
  document.getElementById('loginForm').classList.toggle('hidden', tipo!=='login');
  document.getElementById('registerForm').classList.toggle('hidden', tipo!=='register');
  document.getElementById('tabLogin').style.background = tipo==='login' ? '#4f6ef7' : '#eee';
  document.getElementById('tabLogin').style.color = tipo==='login' ? '#fff' : '#333';
  document.getElementById('tabRegister').style.background = tipo==='register' ? '#4f6ef7' : '#eee';
  document.getElementById('tabRegister').style.color = tipo==='register' ? '#fff' : '#333';
}

document.getElementById('loginForm').addEventListener('submit', async function(e){
  e.preventDefault(); clearMessages();
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  if(!email || !password){ showError('Preencha email e palavra-passe'); return; }
  try{
    await auth.signInWithEmailAndPassword(email,password);
    showSuccess('Login efetuado'); // onAuthStateChanged fará o resto
  }catch(err){
    console.error('Login error',err);
    showError(err.message || 'Erro no login');
  }
});

document.getElementById('registerForm').addEventListener('submit', async function(e){
  e.preventDefault(); clearMessages();
  const name = document.getElementById('registerName').value.trim();
  const email = document.getElementById('registerEmail').value.trim();
  const password = document.getElementById('registerPassword').value;
  if(!name||!email||!password){ showError('Preencha todos os campos'); return; }
  if(password.length < 6){ showError('Password deve ter pelo menos 6 caracteres'); return; }
  try{
    const userCred = await auth.createUserWithEmailAndPassword(email,password);
    await userCred.user.updateProfile({ displayName: name });
    showSuccess('Conta criada. Já pode entrar.');
  }catch(err){
    console.error('Register error',err);
    showError(err.message || 'Erro no registo');
  }
});

auth.onAuthStateChanged(async function(user){
  currentUser = user;
  if(user){
    // logged in
    document.getElementById('authContainer').classList.add('hidden');
    document.getElementById('mainContent').classList.remove('hidden');
    document.getElementById('userNameDisplay').textContent = user.displayName || user.email;
    // reset localFallback flag and try cloud
    localFallback = false;
    setModeIndicator();
    await carregarTurmas();
  } else {
    // show auth
    document.getElementById('authContainer').classList.remove('hidden');
    document.getElementById('mainContent').classList.add('hidden');
  }
});

function logout(){ if(confirm('Sair?')) auth.signOut(); }

/* ---------------------------
   Operações Firestore com fallback local
   - all firestore writes/reads wrapped to detect permission errors
   --------------------------- */
function isPermissionError(err){
  if(!err) return false;
  const code = err.code || '';
  return code === 'permission-denied' || code === 'unauthenticated' || code === 'failed-precondition';
}

/* ---------------------------
   Criar turma (tenta Firestore, se falhar grava local)
   --------------------------- */
document.getElementById('btnCriarTurma').addEventListener('click', async function(){
  clearMessages();
  if(!currentUser){
    showError('Tem de estar autenticado para criar turma.');
    return;
  }
  const nome = document.getElementById('nomeTurma').value.trim();
  const ano = document.getElementById('anoLetivo').value.trim();
  const professor = document.getElementById('nomeProfessor').value.trim();
  if(!nome||!ano||!professor){ showError('Preencha todos os campos da turma'); return; }

  // tenta Firestore
  try{
    const ref = await db.collection('turmas').add({
      userId: currentUser.uid,
      nome, ano, professor,
      criadoEm: firebase.firestore.FieldValue.serverTimestamp()
    });
    showSuccess('Turma criada no Firestore');
    document.getElementById('nomeTurma').value='';
    document.getElementById('anoLetivo').value='';
    document.getElementById('nomeProfessor').value='';
    await carregarTurmas();
    return;
  }catch(err){
    console.warn('Firestore create turma falhou:', err && err.code, err && err.message);
    if(isPermissionError(err)){
      localFallback = true;
      setModeIndicator();
      showError('Sem permissões para gravar no Firestore — a app vai usar armazenamento local (dados só no browser).');
      // fallback local
      const arr = getLocalTurmas();
      const id = 'local-' + Date.now();
      arr.unshift({ id, nome, ano, professor, criadoEm: (new Date()).toISOString() });
      saveLocalTurmas(arr);
      showSuccess('Turma criada localmente');
      document.getElementById('nomeTurma').value='';
      document.getElementById('anoLetivo').value='';
      document.getElementById('nomeProfessor').value='';
      carregarTurmas(); // carrega do local
      return;
    } else {
      showError('Erro ao criar turma: ' + (err.message||err));
      return;
    }
  }
});

/* ---------------------------
   Carregar turmas (tenta Firestore primeiro)
   --------------------------- */
async function carregarTurmas(){
  const container = document.getElementById('listaTurmas');
  container.innerHTML = '<div class="muted">A carregar...</div>';
  if(!currentUser){
    container.innerHTML = '<div class="muted">Faça login para ver as turmas.</div>';
    return;
  }

  // tenta Firestore
  try{
    const snapshot = await db.collection('turmas')
      .where('userId','==', currentUser.uid)
      .orderBy('criadoEm','desc')
      .get();
    // se ok, mostramos só turmas remotas
    if(snapshot.empty){
      container.innerHTML = '<div class="muted">Nenhuma turma criada (na cloud).</div>';
    } else {
      container.innerHTML = '';
      snapshot.forEach(doc => {
        const t = { id: doc.id, ...doc.data(), isLocal:false };
        const el = criarElementoTurma(t);
        container.appendChild(el);
      });
    }
    // keep mode cloud
    localFallback = false;
    setModeIndicator();
  }catch(err){
    console.warn('Erro ao carregar turmas cloud:', err && err.code);
    if(isPermissionError(err)){
      // fallback local
      localFallback = true;
      setModeIndicator();
      showError('Sem permissões para aceder ao Firestore — a app vai usar dados locais.');
      const local = getLocalTurmas();
      if(local.length===0){
        container.innerHTML = '<div class="muted">Nenhuma turma (local)</div>';
      } else {
        container.innerHTML = '';
        local.forEach(t => {
          const el = criarElementoTurma(Object.assign({},t,{isLocal:true}));
          container.appendChild(el);
        });
      }
    } else {
      container.innerHTML = `<div class="muted">Erro ao carregar turmas: ${err.message || err}</div>`;
    }
  }
}

/* ---------------------------
   Cria elemento DOM para uma turma
   --------------------------- */
function criarElementoTurma(t){
  const div = document.createElement('div');
  div.className = 'turma-item';
  div.innerHTML = `
    <div>
      <strong>${escapeHtml(t.nome)}</strong><br>
      <small class="muted">${escapeHtml(t.ano)} • ${escapeHtml(t.professor)} ${t.isLocal? ' (local)':''}</small>
    </div>
    <div class="turma-actions">
      <button data-id="${t.id}" class="select-btn">Selecionar</button>
      <button data-id="${t.id}" class="delete-btn" style="background:#ef4444">Eliminar</button>
    </div>
  `;
  // selecionar
  div.querySelector('.select-btn').addEventListener('click', ()=> selecionarTurma(t));
  // eliminar
  div.querySelector('.delete-btn').addEventListener('click', ()=> eliminarTurma(t));
  return div;
}

/* ---------------------------
   Selecionar turma (t: {id,nome,ano,professor,isLocal})
   --------------------------- */
function selecionarTurma(t){
  turmaAtiva = t;
  document.getElementById('turmaSelecionadaNome').textContent = t.nome + (t.isLocal? ' (local)':'');
  document.getElementById('cardSemana').classList.remove('hidden');
  document.getElementById('areaPlanificacao').classList.add('hidden');
  carregarSemanas();
  showSuccess(`Turma selecionada: ${t.nome}`);
}

/* ---------------------------
   Eliminar turma (t can be object or id)
   if t.isLocal true => delete in localStorage
   else attempt firestore delete (with semanas)
   --------------------------- */
async function eliminarTurma(tOrId){
  let id, isLocal=false;
  if(typeof tOrId === 'string'){ id = tOrId; } else { id = tOrId.id; isLocal = !!tOrId.isLocal; }
  if(!confirm('Eliminar turma e todas as suas semanas?')) return;

  if(isLocal || localFallback){
    // local removal
    const turmas = getLocalTurmas();
    const idx = turmas.findIndex(x=>x.id===id);
    if(idx>=0){ turmas.splice(idx,1); saveLocalTurmas(turmas); }
    // remove local semanas
    let semanas = getLocalSemanas();
    semanas = semanas.filter(s=>s.turmaId !== id);
    saveLocalSemanas(semanas);
    if(turmaAtiva && turmaAtiva.id===id) { turmaAtiva=null; document.getElementById('cardSemana').classList.add('hidden'); document.getElementById('areaPlanificacao').classList.add('hidden'); }
    showSuccess('Turma e semanas (local) eliminadas.');
    carregarTurmas();
    return;
  }

  // try cloud
  try{
    // remove semanas in batch
    const semanasSnap = await db.collection('semanas').where('turmaId','==', id).get();
    const batch = db.batch();
    semanasSnap.forEach(doc => batch.delete(doc.ref));
    batch.delete(db.collection('turmas').doc(id));
    await batch.commit();
    if(turmaAtiva && turmaAtiva.id===id){ turmaAtiva=null; document.getElementById('cardSemana').classList.add('hidden'); document.getElementById('areaPlanificacao').classList.add('hidden'); }
    showSuccess('Turma e semanas eliminadas (cloud).');
    carregarTurmas();
  }catch(err){
    console.error('Erro eliminar turma cloud',err);
    if(isPermissionError(err)){
      // fallback local
      localFallback = true; setModeIndicator();
      showError('Sem permissões para eliminar no Firestore — a app usará armazenamento local.');
      // try local deletion anyway (in case there are local entries)
      const turmas = getLocalTurmas(); const idx = turmas.findIndex(x=>x.id===id); if(idx>=0){ turmas.splice(idx,1); saveLocalTurmas(turmas); }
      let semanas = getLocalSemanas(); semanas = semanas.filter(s=>s.turmaId !== id); saveLocalSemanas(semanas);
      carregarTurmas();
    } else {
      showError('Erro ao eliminar turma: ' + (err.message||err));
    }
  }
}

/* ---------------------------
   Semanas: criar (confirmarSemana) / carregar / abrir / eliminar
   - fallback local se necessário
   --------------------------- */
function criarSemanaRapida(tipo){
  const hoje = new Date();
  let monday;
  if(tipo === 'esta'){
    const dayOfWeek = hoje.getDay(); // 0 dom...6 sab
    const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    monday = new Date(hoje); monday.setDate(hoje.getDate() + diff);
  } else if(tipo === 'proxima'){
    const dayOfWeek = hoje.getDay();
    const diff = dayOfWeek === 0 ? 1 : 8 - dayOfWeek;
    monday = new Date(hoje); monday.setDate(hoje.getDate() + diff);
  } else { // custom
    document.getElementById('calendarContainer').classList.remove('hidden');
    generateCalendar();
    return;
  }
  const friday = new Date(monday); friday.setDate(monday.getDate() + 4);
  selectedWeekStart = monday; selectedWeekEnd = friday;
  mostrarSemanaSelecionada();
}

function generateCalendar(){
  const year = calendarDate.getFullYear();
  const month = calendarDate.getMonth();
  document.getElementById('calendarTitle').textContent = new Intl.DateTimeFormat('pt-PT',{month:'long',year:'numeric'}).format(calendarDate);
  const first = new Date(year, month, 1);
  const start = new Date(first); start.setDate(first.getDate() - first.getDay());
  const grid = document.getElementById('calendarGrid');
  grid.innerHTML = '';
  for(let i=0;i<42;i++){
    const d = new Date(start); d.setDate(start.getDate() + i);
    const el = document.createElement('div');
    el.style.padding = '10px';
    el.style.borderRadius = '8px';
    el.style.textAlign = 'center';
    el.style.cursor = 'pointer';
    el.textContent = d.getDate();
    if(d.getMonth() !== month) el.style.opacity = '0.4';
    if(isSameDay(d,new Date())) el.style.background = '#e0f2ff';
    el.onclick = ()=> { selectWeek(d); };
    grid.appendChild(el);
  }
}

function isSameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

function changeMonth(dir){ calendarDate.setMonth(calendarDate.getMonth()+dir); generateCalendar(); }

function selectWeek(clickedDate){
  const dayOfWeek = clickedDate.getDay();
  const monday = new Date(clickedDate); monday.setDate(clickedDate.getDate() - dayOfWeek + (dayOfWeek===0?-6:1));
  const friday = new Date(monday); friday.setDate(monday.getDate() + 4);
  selectedWeekStart = monday; selectedWeekEnd = friday;
  mostrarSemanaSelecionada();
}

function mostrarSemanaSelecionada(){
  if(!selectedWeekStart || !selectedWeekEnd) return;
  document.getElementById('weekRangeText').textContent = `${selectedWeekStart.toLocaleDateString('pt-PT')} → ${selectedWeekEnd.toLocaleDateString('pt-PT')}`;
  document.getElementById('selectedWeek').classList.remove('hidden');
  // attach confirm handler
  const btn = document.getElementById('btnConfirmWeek');
  btn.onclick = confirmarSemana;
}

/* confirmarSemana: cria semana no cloud ou local */
async function confirmarSemana(){
  if(!turmaAtiva){ showError('Selecione uma turma antes.'); return; }
  if(!selectedWeekStart || !selectedWeekEnd){ showError('Selecione uma semana.'); return; }
  const descricao = `${selectedWeekStart.toLocaleDateString('pt-PT')} a ${selectedWeekEnd.toLocaleDateString('pt-PT')}`;
  // try cloud
  try{
    const ref = await db.collection('semanas').add({
      turmaId: turmaAtiva.id,
      descricao,
      dataInicio: firebase.firestore.Timestamp.fromDate(selectedWeekStart),
      dataFim: firebase.firestore.Timestamp.fromDate(selectedWeekEnd),
      criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
      planificacao: {}
    });
    showSuccess('Semana criada (cloud)');
    selectedWeekStart = selectedWeekEnd = null;
    document.getElementById('selectedWeek').classList.add('hidden');
    document.getElementById('calendarContainer').classList.add('hidden');
    carregarSemanas();
    return;
  }catch(err){
    console.warn('Erro criar semana cloud',err);
    if(isPermissionError(err)){
      localFallback = true; setModeIndicator();
      showError('Sem permissões para criar semana no Firestore — a app vai guardar localmente.');
      // create local semana
      const semanas = getLocalSemanas();
      const id = 'local-' + Date.now();
      semanas.unshift({
        id, turmaId: turmaAtiva.id, descricao,
        dataInicio: selectedWeekStart.toISOString(), dataFim: selectedWeekEnd.toISOString(),
        criadoEm: (new Date()).toISOString(), planificacao: {}
      });
      saveLocalSemanas(semanas);
      showSuccess('Semana criada localmente');
      selectedWeekStart = selectedWeekEnd = null;
      document.getElementById('selectedWeek').classList.add('hidden');
      document.getElementById('calendarContainer').classList.add('hidden');
      carregarSemanas();
      return;
    } else {
      showError('Erro ao criar semana: ' + (err.message||err));
    }
  }
}

/* carregarSemanas: carrega semanas da turma selecionada (cloud preferencial, fallback local) */
async function carregarSemanas(){
  const lista = document.getElementById('listaSemanas'); lista.innerHTML = '';
  if(!turmaAtiva){ lista.innerHTML = '<div class="muted">Selecione uma turma</div>'; return; }
  // try cloud query
  try{
    const snap = await db.collection('semanas').where('turmaId','==',turmaAtiva.id).orderBy('criadoEm','desc').get();
    if(snap.empty){ lista.innerHTML = '<div class="muted">Nenhuma semana (cloud)</div>'; }
    snap.forEach(doc => {
      const s = { id: doc.id, ...doc.data(), isLocal:false };
      const el = criarElementoSemana(s);
      lista.appendChild(el);
    });
    localFallback = false; setModeIndicator();
  }catch(err){
    console.warn('Erro carregar semanas cloud',err);
    if(isPermissionError(err)){
      localFallback = true; setModeIndicator();
      showError('Sem permissões para ler semanas no Firestore — a app usará semanas locais.');
      const local = getLocalSemanas().filter(s=>s.turmaId === turmaAtiva.id);
      if(local.length===0) lista.innerHTML = '<div class="muted">Nenhuma semana (local)</div>';
      else local.forEach(s => lista.appendChild(criarElementoSemana(Object.assign({},s,{isLocal:true}))));
    } else {
      lista.innerHTML = `<div class="muted">Erro ao carregar semanas: ${err.message||err}</div>`;
    }
  }
}

function criarElementoSemana(s){
  const div = document.createElement('div');
  div.className = 'semana-item';
  div.innerHTML = `
    <div><strong>${escapeHtml(s.descricao)}</strong></div>
    <div class="semana-actions">
      <button data-id="${s.id}" class="open-btn">Abrir</button>
      <button data-id="${s.id}" class="edit-btn">Editar</button>
      <button data-id="${s.id}" class="del-btn" style="background:#ef4444">Eliminar</button>
    </div>
  `;
  div.querySelector('.open-btn').addEventListener('click', ()=> abrirPlanificacao(s));
  div.querySelector('.edit-btn').addEventListener('click', ()=> {
    // if cloud -> call editarSemana with cloud params; if local -> reconstruct
    if(s.isLocal){
      const sd = new Date(s.dataInicio); const ed = new Date(s.dataFim);
      editarSemanaLocal(s.id, s.descricao, sd, ed);
    } else {
      // cloud: s.dataInicio is Timestamp
      editarSemanaCloud(s.id, s.descricao, s.dataInicio.toDate(), s.dataFim.toDate());
    }
  });
  div.querySelector('.del-btn').addEventListener('click', ()=> eliminarSemana(s));
  return div;
}

/* editar semana - separate paths for cloud/local */
function editarSemanaCloud(semanaId, descricao, dStart, dEnd){
  selectedWeekStart = dStart; selectedWeekEnd = dEnd;
  document.getElementById('calendarContainer').classList.remove('hidden'); generateCalendar(); mostrarSemanaSelecionada();
  const btn = document.getElementById('btnConfirmWeek');
  btn.textContent = 'Atualizar semana';
  btn.onclick = async ()=>{
    try{
      await db.collection('semanas').doc(semanaId).update({
        descricao: `${selectedWeekStart.toLocaleDateString('pt-PT')} a ${selectedWeekEnd.toLocaleDateString('pt-PT')}`,
        dataInicio: firebase.firestore.Timestamp.fromDate(selectedWeekStart),
        dataFim: firebase.firestore.Timestamp.fromDate(selectedWeekEnd),
        atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
      });
      showSuccess('Semana atualizada (cloud)');
      document.getElementById('selectedWeek').classList.add('hidden'); document.getElementById('calendarContainer').classList.add('hidden');
      btn.textContent = 'Criar esta semana';
      btn.onclick = confirmarSemana;
      carregarSemanas();
    }catch(err){
      console.error('Erro atualizar semana cloud',err);
      if(isPermissionError(err)){ localFallback=true; setModeIndicator(); showError('Sem permissões para atualizar semana no Firestore.'); }
      else showError('Erro ao atualizar: ' + err.message);
    }
  };
}

function editarSemanaLocal(semanaId, descricao, dStart, dEnd){
  selectedWeekStart = dStart; selectedWeekEnd = dEnd;
  document.getElementById('calendarContainer').classList.remove('hidden'); generateCalendar(); mostrarSemanaSelecionada();
  const btn = document.getElementById('btnConfirmWeek');
  btn.textContent = 'Atualizar semana (local)';
  btn.onclick = ()=>{
    let semanas = getLocalSemanas();
    const idx = semanas.findIndex(s=>s.id===semanaId);
    if(idx<0){ showError('Semana local não encontrada'); return; }
    semanas[idx].descricao = `${selectedWeekStart.toLocaleDateString('pt-PT')} a ${selectedWeekEnd.toLocaleDateString('pt-PT')}`;
    semanas[idx].dataInicio = selectedWeekStart.toISOString();
    semanas[idx].dataFim = selectedWeekEnd.toISOString();
    semanas[idx].atualizadoEm = (new Date()).toISOString();
    saveLocalSemanas(semanas);
    showSuccess('Semana local atualizada');
    document.getElementById('selectedWeek').classList.add('hidden'); document.getElementById('calendarContainer').classList.add('hidden');
    btn.textContent = 'Criar esta semana';
    btn.onclick = confirmarSemana;
    carregarSemanas();
  };
}

/* abrirPlanificacao(s) where s may be cloud or local */
async function abrirPlanificacao(s){
  // s can be object (with id) or id param; ensure s object
  const semana = s;
  semanaAtiva = { id: semana.id, descricao: semana.descricao, isLocal: !!semana.isLocal };
  document.getElementById('tituloAtual').textContent = `Planificação: ${semana.descricao}`;
  document.getElementById('infoAtual').textContent = `${turmaAtiva.nome} • ${turmaAtiva.ano} • ${turmaAtiva.professor}`;
  document.getElementById('areaPlanificacao').classList.remove('hidden');
  // load data (cloud or local)
  if(semanaAtiva.isLocal || localFallback){
    // local
    const local = getLocalSemanas().find(x=>x.id===semana.id);
    const plan = local && local.planificacao ? local.planificacao : {};
    fillPlanGrid(plan);
  } else {
    try{
      const docSnap = await db.collection('semanas').doc(semana.id).get();
      if(!docSnap.exists){ showError('Documento da semana não existe (cloud)'); return; }
      const plan = docSnap.data().planificacao || {};
      fillPlanGrid(plan);
    }catch(err){
      console.error('Erro ler planificacao cloud',err);
      if(isPermissionError(err)){ localFallback=true; setModeIndicator(); showError('Sem permissões para ler planificação no Firestore.'); }
      else showError('Erro ao carregar planificação: ' + err.message);
    }
  }
  // show week full by default
  mostrarSemanaCompleta();
}

function fillPlanGrid(planObj){
  const textareas = document.querySelectorAll('.content-cell textarea');
  textareas.forEach(t=>{
    const cell = t.closest('.content-cell');
    const key = `${cell.getAttribute('data-day')}-${cell.getAttribute('data-time')}`;
    t.value = planObj[key] || '';
  });
}

/* eliminarSemana (cloud/local) */
async function eliminarSemana(sOrId){
  const id = typeof sOrId === 'string' ? sOrId : sOrId.id;
  if(!confirm('Eliminar esta semana?')) return;
  // local?
  if(sOrId.isLocal || localFallback){
    let semanas = getLocalSemanas();
    semanas = semanas.filter(s=>s.id !== id);
    saveLocalSemanas(semanas);
    showSuccess('Semana local eliminada');
    carregarSemanas();
    if(semanaAtiva && semanaAtiva.id === id){ semanaAtiva=null; document.getElementById('areaPlanificacao').classList.add('hidden'); }
    return;
  }
  // cloud
  try{
    await db.collection('semanas').doc(id).delete();
    showSuccess('Semana eliminada (cloud)');
    carregarSemanas();
    if(semanaAtiva && semanaAtiva.id === id){ semanaAtiva=null; document.getElementById('areaPlanificacao').classList.add('hidden'); }
  }catch(err){
    console.error('Erro eliminar semana cloud',err);
    if(isPermissionError(err)){ localFallback=true; setModeIndicator(); showError('Sem permissões para eliminar semana no Firestore.'); }
    else showError('Erro ao eliminar semana: ' + err.message);
  }
}

/* salvarPlanificacao() - atualiza cloud se possível, caso contrário guarda local */
async function salvarPlanificacao(){
  if(!turmaAtiva || !semanaAtiva){ showError('Selecione turma e semana antes de guardar'); return; }
  const planObj = {};
  document.querySelectorAll('.content-cell textarea').forEach(t=>{
    const cell = t.closest('.content-cell');
    const key = `${cell.getAttribute('data-day')}-${cell.getAttribute('data-time')}`;
    planObj[key] = t.value;
  });

  if(semanaAtiva.isLocal || localFallback){
    // save local
    const semanas = getLocalSemanas();
    const idx = semanas.findIndex(s=>s.id === semanaAtiva.id);
    if(idx<0){
      // create local week entry
      semanas.unshift({
        id: semanaAtiva.id || ('local-'+Date.now()),
        turmaId: turmaAtiva.id,
        descricao: semanaAtiva.descricao || '',
        dataInicio: (new Date()).toISOString(),
        dataFim: (new Date()).toISOString(),
        planificacao: planObj,
        criadoEm: (new Date()).toISOString()
      });
    } else {
      semanas[idx].planificacao = planObj;
      semanas[idx].atualizadoEm = (new Date()).toISOString();
    }
    saveLocalSemanas(semanas);
    showSuccess('Planificação guardada localmente');
    return;
  }

  // try cloud update
  try{
    await db.collection('semanas').doc(semanaAtiva.id).update({
      planificacao: planObj,
      atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
    });
    showSuccess('Planificação guardada no Firestore');
  }catch(err){
    console.error('Erro guardar planificacao cloud',err);
    if(isPermissionError(err)){
      localFallback = true; setModeIndicator();
      showError('Sem permissões para gravar planificação no Firestore — guardando localmente.');
      // save local
      const semanas = getLocalSemanas();
      const idx = semanas.findIndex(s=>s.id === semanaAtiva.id);
      if(idx>=0){ semanas[idx].planificacao = planObj; semanas[idx].atualizadoEm = (new Date()).toISOString(); }
      else semanas.unshift({ id: semanaAtiva.id || ('local-'+Date.now()), turmaId: turmaAtiva.id, descricao: semanaAtiva.descricao||'', dataInicio: (new Date()).toISOString(), dataFim: (new Date()).toISOString(), planificacao: planObj, criadoEm:(new Date()).toISOString() });
      saveLocalSemanas(semanas);
      showSuccess('Planificação guardada localmente');
    } else showError('Erro ao guardar planificação: ' + (err.message||err));
  }
}

/* mostrar / esconder dias */
function mostrarSemanaCompleta(){
  document.querySelectorAll('.day-header').forEach(h=>{ h.classList.remove('hidden'); h.classList.remove('active-day'); });
  document.querySelectorAll('.day-cell').forEach(c=>{ c.classList.remove('hidden'); c.classList.remove('active-day'); });
}
function mostrarDia(dia){
  document.querySelectorAll('.day-header').forEach(h=>{ if(h.getAttribute('data-day')===dia){ h.classList.remove('hidden'); h.classList.add('active-day'); } else { h.classList.add('hidden'); h.classList.remove('active-day'); }});
  document.querySelectorAll('.day-cell').forEach(c=>{ if(c.getAttribute('data-day')===dia){ c.classList.remove('hidden'); c.classList.add('active-day'); } else { c.classList.add('hidden'); c.classList.remove('active-day'); }});
}

/* quick init: hide messages / set mode */
setModeIndicator();
mostrarForm('login');

/* small helper to escape HTML in strings */
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
</script>
</body>
</html>
