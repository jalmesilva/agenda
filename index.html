<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Planificação — Professores 1.º Ciclo</title>
<style>
  :root{--blue:#2563eb;--danger:#ef4444}
  body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#f6f8fb;color:#111}
  .wrap{max-width:1100px;margin:0 auto}
  .card{background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 6px 20px rgba(15,23,42,0.06)}
  h1,h2{margin:0 0 8px 0}
  input,select,textarea,button{padding:8px;border-radius:8px;border:1px solid #d1d5db}
  button{background:var(--blue);color:#fff;border:0;cursor:pointer}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .muted{color:#6b7280;font-size:13px}
  .turma-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#f8fafc;margin-bottom:8px}
  .turma-actions button{margin-left:8px;padding:6px 10px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  table th,table td{border:1px solid #e6e6e6;padding:6px;vertical-align:top}
  .time-col{width:160px;background:#eef2ff;font-weight:700;text-align:center}
  textarea.cell{width:100%;height:70px;border:0;resize:vertical;padding:6px;font-family:inherit}
  .small {font-size:13px}
  .danger {background:var(--danger);color:#fff;border:none}
  .controls {display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">

  <div id="auth" class="card">
    <h1>Planificação — Login</h1>
    <div class="row">
      <div>
        <input id="email" type="email" placeholder="Email" />
      </div>
      <div>
        <input id="password" type="password" placeholder="Password" />
      </div>
    </div>
    <div style="margin-top:8px">
      <button id="btnLogin">Entrar</button>
      <button id="btnLogout" style="display:none;margin-left:8px;background:#6b7280">Sair</button>
      <span id="userInfo" class="muted" style="margin-left:12px"></span>
    </div>
    <p id="authMsg" class="muted small" style="margin-top:8px">Usa contas criadas no Firebase Auth. Regras Firestore devem permitir o acesso aos teus emails.</p>
  </div>

  <div id="app" class="card" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h2>Gestão de Turmas</h2>
        <div class="muted small">Coleções usadas: <strong>turmas</strong> → subcoleção <strong>semanas</strong></div>
      </div>
      <div class="muted small">Utilizador: <span id="who"></span></div>
    </div>

    <!-- criar turma -->
    <div style="margin-top:12px" class="card">
      <h3>Criar Turma</h3>
      <div class="row">
        <input id="turmaNome" placeholder="Nome da turma (ex.: 4.º A)" />
        <input id="turmaAno" placeholder="Ano letivo (ex.: 2024/2025)" />
      </div>
      <div style="margin-top:8px" class="row">
        <input id="turmaProf" placeholder="Professor responsável (email ou nome)" />
        <div>
          <button id="btnCriarTurma">Criar Turma</button>
        </div>
      </div>
      <p id="turmaMsg" class="muted small" style="margin-top:6px"></p>
    </div>

    <!-- lista turmas -->
    <div class="card">
      <h3>Turmas</h3>
      <div id="listaTurmas"></div>
    </div>

    <!-- semanas: selecionar -->
    <div id="panelSemanas" class="card" style="display:none">
      <h3>Semanas — Turma: <span id="turmaNomeAtiva"></span></h3>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <label class="small">Início: <input id="semInicio" type="date" /></label>
        <label class="small">Fim: <input id="semFim" type="date" /></label>
        <button id="btnGerarGrelha">Gerar Grelha</button>
        <button id="btnCarregarSemanas" style="background:#6b7280">Carregar semanas</button>
      </div>

      <div id="listaSemanas"></div>
    </div>

    <!-- area planificacao -->
    <div id="areaPlan" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 id="tituloSemana">Planificação</h3>
          <div class="muted small" id="subtituloSemana"></div>
        </div>
        <div class="controls">
          <button id="btnVerSemana">Ver semana</button>
          <select id="selectDia" style="min-width:160px">
            <option value="">Ver dia específico</option>
          </select>
          <button id="btnEliminarSemana" class="danger">Eliminar semana</button>
        </div>
      </div>

      <div id="grelhaWrapper" style="overflow:auto;margin-top:12px"></div>
    </div>

  </div>
</div>

<script type="module">
/* ====== Firebase modular (imports) ====== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs, query, where, orderBy, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ====== Config - usa a tua config (projeto bddespesas) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyAC9EguGeZd50W1jADEx73aJKGacFeGk9o",
  authDomain: "bddespesas.firebaseapp.com",
  projectId: "bddespesas",
  storageBucket: "bddespesas.firebasestorage.app",
  messagingSenderId: "521648200265",
  appId: "1:521648200265:web:82fc2c97f02e185478fd98",
  measurementId: "G-P7NX1T9RVE"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ====== Constantes ====== */
const HORARIOS = ["09:05-10:30","11:00-12:30","13:45-15:30","16:00-17:15"];

/* ====== UI refs ====== */
const el = id => document.getElementById(id);
const who = el('who');
const authMsg = el('authMsg');
const btnLogin = el('btnLogin');
const btnLogout = el('btnLogout');
const btnCriarTurma = el('btnCriarTurma');
const listaTurmas = el('listaTurmas');
const turmaNomeAtiva = el('turmaNomeAtiva');
const panelSemanas = el('panelSemanas');
const listaSemanas = el('listaSemanas');
const semInicio = el('semInicio'), semFim = el('semFim'), btnGerarGrelha = el('btnGerarGrelha');
const areaPlan = el('areaPlan'), tituloSemana = el('tituloSemana'), subtituloSemana = el('subtituloSemana');
const grelhaWrapper = el('grelhaWrapper'), btnVerSemana = el('btnVerSemana'), selectDia = el('selectDia');
const btnEliminarSemana = el('btnEliminarSemana'), btnCarregarSemanas = el('btnCarregarSemanas');
const turmaMsg = el('turmaMsg');

/* ====== Estado ====== */
let currentUser = null;
let turmaAtiva = null;   // { id, nome, ano, professor }
let semanaAtiva = null;  // { id, inicio, fim }

/* ====== Autenticação ====== */
btnLogin.addEventListener('click', async () => {
  authMsg.textContent = '';
  const email = el('email').value.trim();
  const password = el('password').value;
  if(!email || !password){ authMsg.textContent = 'Preencha email e password.'; return; }
  try{
    await signInWithEmailAndPassword(auth, email, password);
  }catch(err){
    console.error(err);
    authMsg.textContent = err.message || 'Erro no login.';
  }
});
btnLogout.addEventListener('click', async () => {
  await signOut(auth);
});

/* onAuthStateChanged */
onAuthStateChanged(auth, user => {
  currentUser = user;
  if(user){
    el('auth').style.display = 'none';
    el('app').style.display = 'block';
    who.textContent = user.email;
    loadTurmas();
  } else {
    el('auth').style.display = 'block';
    el('app').style.display = 'none';
  }
});

/* ====== Turmas ====== */
btnCriarTurma.addEventListener('click', async () => {
  turmaMsg.textContent = '';
  if(!currentUser) { turmaMsg.textContent = 'Faça login primeiro.'; return; }
  const nome = el('turmaNome').value.trim();
  const ano = el('turmaAno').value.trim();
  const prof = el('turmaProf').value.trim();
  if(!nome || !ano || !prof){ turmaMsg.textContent = 'Preencha todos os campos.'; return; }
  try{
    const docRef = await addDoc(collection(db,'turmas'), {
      nome, ano, professor: prof, owner: currentUser.uid, createdAt: new Date().toISOString()
    });
    el('turmaNome').value=''; el('turmaAno').value=''; el('turmaProf').value='';
    loadTurmas();
  }catch(err){
    console.error('Erro criar turma',err);
    turmaMsg.textContent = 'Erro ao criar turma: ' + (err.message||err);
  }
});

/* loadTurmas - mostra lista e botoes */
async function loadTurmas(){
  listaTurmas.innerHTML = 'A carregar...';
  try{
    const q = query(collection(db,'turmas'), orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    listaTurmas.innerHTML = '';
    if(snap.empty){ listaTurmas.innerHTML = '<div class="muted">Nenhuma turma.</div>'; return; }
    snap.forEach(d => {
      const data = d.data();
      const id = d.id;
      const div = document.createElement('div');
      div.className = 'turma-item';
      div.innerHTML = `
        <div>
          <strong>${escapeHtml(data.nome)}</strong><br>
          <span class="muted small">${escapeHtml(data.ano)} • ${escapeHtml(data.professor)}</span>
        </div>
        <div class="turma-actions">
          <button data-id="${id}" class="select">Abrir</button>
          <button data-id="${id}" class="delete" style="background:#ef4444">Eliminar</button>
        </div>
      `;
      div.querySelector('.select').addEventListener('click', ()=> selectTurma({ id, ...data }));
      div.querySelector('.delete').addEventListener('click', ()=> deleteTurma(id));
      listaTurmas.appendChild(div);
    });
  }catch(err){
    console.error('Erro loadTurmas',err);
    listaTurmas.innerHTML = '<div class="muted">Erro ao carregar turmas.</div>';
  }
}

/* selectTurma */
function selectTurma(t){
  turmaAtiva = t;
  turmaNomeAtiva.textContent = t.nome;
  panelSemanas.style.display = 'block';
  listaSemanas.innerHTML = '';
  areaPlan.style.display = 'none';
  loadSemanas();
}

/* deleteTurma - apaga subcoleção semanas e depois turma doc */
async function deleteTurma(id){
  if(!confirm('Eliminar esta turma e todas as semanas?')) return;
  try{
    // apagar semanas (leitura e apagar cada)
    const semSnap = await getDocs(collection(db,'turmas',id,'semanas'));
    const deletes = [];
    semSnap.forEach(sdoc => deletes.push(deleteDoc(doc(db,'turmas',id,'semanas',sdoc.id))));
    await Promise.all(deletes);
    // apagar turma
    await deleteDoc(doc(db,'turmas',id));
    if(turmaAtiva && turmaAtiva.id === id) { turmaAtiva = null; panelSemanas.style.display = 'none'; areaPlan.style.display = 'none'; }
    loadTurmas();
  }catch(err){
    console.error('Erro deleteTurma',err);
    alert('Erro ao eliminar turma: ' + (err.message||err));
  }
}

/* ====== Semanas ====== */
/* loadSemanas */
async function loadSemanas(){
  listaSemanas.innerHTML = 'A carregar semanas...';
  try{
    const q = query(collection(db,'turmas',turmaAtiva.id,'semanas'), orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    listaSemanas.innerHTML = '';
    if(snap.empty){ listaSemanas.innerHTML = '<div class="muted">Nenhuma semana criada.</div>'; return; }
    snap.forEach(d => {
      const data = d.data();
      const id = d.id;
      const div = document.createElement('div');
      div.className = 'turma-item';
      div.innerHTML = `<div><strong>${escapeHtml(data.rangeText || data.inicio + ' → ' + data.fim)}</strong><br><span class="muted small">${data.createdAt || ''}</span></div>
        <div class="turma-actions">
          <button data-id="${id}" class="open">Abrir</button>
          <button data-id="${id}" class="delete" style="background:#ef4444">Eliminar</button>
        </div>`;
      div.querySelector('.open').addEventListener('click', ()=> openSemana({ id, ...data }));
      div.querySelector('.delete').addEventListener('click', ()=> deleteSemana(id));
      listaSemanas.appendChild(div);
    });
  }catch(err){
    console.error('Erro loadSemanas',err);
    listaSemanas.innerHTML = '<div class="muted">Erro ao carregar semanas.</div>';
  }
}

/* deleteSemana */
async function deleteSemana(semId){
  if(!confirm('Eliminar esta semana?')) return;
  try{
    await deleteDoc(doc(db,'turmas',turmaAtiva.id,'semanas',semId));
    if(semanaAtiva && semanaAtiva.id === semId){ semanaAtiva = null; areaPlan.style.display = 'none'; }
    loadSemanas();
  }catch(err){
    console.error('Erro deleteSemana',err);
    alert('Erro ao eliminar semana: ' + (err.message||err));
  }
}

/* btnGerarGrelha -> cria documento da semana (com planificacao inicial vazia) */
btnGerarGrelha.addEventListener('click', async ()=>{
  if(!turmaAtiva){ alert('Selecione uma turma'); return; }
  const inicio = semInicio.value;
  const fim = semFim.value;
  if(!inicio || !fim){ alert('Escolha data início e fim'); return; }
  if(new Date(fim) < new Date(inicio)){ alert('Data fim deve ser depois da de início'); return; }
  // gerar lista de datas entre inicio e fim (inclusive)
  const dates = datesBetween(inicio, fim);
  const rangeText = formatDisplayRange(inicio, fim);
  // criar objeto planificacao com arrays por data (um slot por horário)
  const planificacao = {};
  dates.forEach(d => planificacao[d] = HORARIOS.map(_=> ''));
  try{
    const docRef = await addDoc(collection(db,'turmas',turmaAtiva.id,'semanas'), {
      inicio, fim, rangeText, createdAt: new Date().toISOString(), horarios: HORARIOS, planificacao
    });
    // abrir logo a semana criada
    openSemana({ id: docRef.id, inicio, fim, rangeText, horarios: HORARIOS, planificacao });
    loadSemanas();
  }catch(err){
    console.error('Erro criar semana',err);
    alert('Erro ao criar semana: ' + (err.message||err));
  }
});

/* openSemana - carrega planificacao e monta grelha */
async function openSemana(sem){
  // sem may be object with planificacao or without (cloud read)
  try{
    let data;
    if(sem.planificacao){
      data = sem;
    } else {
      const docRef = doc(db,'turmas',turmaAtiva.id,'semanas',sem.id);
      const snap = await getDoc(docRef);
      if(!snap.exists()){ alert('Semana não encontrada'); return; }
      data = snap.data();
    }
    semanaAtiva = { id: sem.id || sem.id, inicio: data.inicio, fim: data.fim, rangeText: data.rangeText, horarios: data.horarios || HORARIOS };
    tituloSemana.textContent = `Planificação — ${turmaAtiva.nome}`;
    subtituloSemana.textContent = data.rangeText || (data.inicio + ' → ' + data.fim);
    // fill selectDia
    fillSelectDays(data.inicio, data.fim);
    // render grid
    renderGrid(data.inicio, data.fim, data.planificacao || {});
    areaPlan.style.display = 'block';
  }catch(err){
    console.error('Erro openSemana',err);
    alert('Erro ao abrir semana: ' + (err.message||err));
  }
}

/* renderGrid */
function renderGrid(inicio, fim, planObj){
  const dates = datesBetween(inicio,fim);
  // build table
  let html = '<table><thead><tr><th class="time-col">Horários</th>';
  dates.forEach(d=>{
    const dt = new Date(d);
    html += `<th>${weekdayName(dt)}<br><small class="muted">${formatDateShort(d)}</small></th>`;
  });
  html += '</tr></thead><tbody>';
  HORARIOS.forEach((slot, slotIndex)=>{
    html += `<tr><td class="time-col">${slot}</td>`;
    dates.forEach(d=>{
      const key = d;
      const value = (planObj && planObj[key] && planObj[key][slotIndex]) ? escapeHtml(planObj[key][slotIndex]) : '';
      html += `<td data-date="${d}" data-slot="${slotIndex}" class="cell-td"><textarea class="cell" spellcheck="false">${value}</textarea></td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  grelhaWrapper.innerHTML = html;
  // set semanaAtiva.planificacao current for saving
  semanaAtiva.planificacao = planObj || {};
  // attach blur listeners to save on change
  document.querySelectorAll('.cell-td textarea').forEach(textarea=>{
    textarea.addEventListener('blur', async (e)=>{
      const td = e.target.closest('.cell-td');
      const date = td.getAttribute('data-date');
      const slot = parseInt(td.getAttribute('data-slot'));
      const newVal = e.target.value;
      // update semanaAtiva.planificacao
      if(!semanaAtiva.planificacao[date]) semanaAtiva.planificacao[date] = HORARIOS.map(_=>'');
      semanaAtiva.planificacao[date][slot] = newVal;
      // save to Firestore (update planificacao map)
      try{
        await updateDoc(doc(db,'turmas',turmaAtiva.id,'semanas',semanaAtiva.id), { planificacao: semanaAtiva.planificacao });
      }catch(err){
        console.error('Erro ao guardar célula',err);
        alert('Erro ao guardar (ver consola).');
      }
    });
  });
  // populate selectDia with dates
  populateSelectDay(dates);
}

/* fillSelectDays */
function fillSelectDays(inicio,fim){
  const dates = datesBetween(inicio,fim);
  populateSelectDay(dates);
}

/* populateSelectDay */
function populateSelectDay(dates){
  selectDia.innerHTML = '<option value="">Ver dia específico</option>';
  dates.forEach(d=>{
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = `${weekdayName(new Date(d))} — ${formatDateShort(d)}`;
    selectDia.appendChild(opt);
  });
}

/* btnVerSemana / selectDia change */
btnVerSemana.addEventListener('click', ()=> {
  // show all (remove style)
  document.querySelectorAll('.cell-td').forEach(td => td.style.display = '');
  document.querySelectorAll('table thead th').forEach(th => th.style.display = '');
});
selectDia.addEventListener('change', (e)=>{
  const date = e.target.value;
  if(!date){
    // show all
    document.querySelectorAll('.cell-td').forEach(td => td.style.display = '');
    document.querySelectorAll('table thead th').forEach(th => th.style.display = '');
    return;
  }
  // hide all columns except the time col and the chosen date column
  const headers = Array.from(document.querySelectorAll('table thead th'));
  const idx = headers.findIndex(h => h.getAttribute('data-date') === date || h.textContent.includes(formatDateShort(date)));
  // instead of relying on data-date in th, we match by order: first th is times, subsequent map to datesBetween order
  const dates = datesBetween(semanaAtiva.inicio, semanaAtiva.fim);
  document.querySelectorAll('table thead th').forEach((th,i)=>{
    if(i===0) { th.style.display = ''; return; }
    const colDate = dates[i-1];
    if(colDate === date) th.style.display = ''; else th.style.display = 'none';
  });
  // columns: hide or show td based on data-date attribute
  document.querySelectorAll('.cell-td').forEach(td=>{
    td.style.display = td.getAttribute('data-date') === date ? '' : 'none';
  });
});

/* helper datesBetween inclusive */
function datesBetween(start, end){
  const arr = [];
  let cur = new Date(start);
  const last = new Date(end);
  while(cur <= last){
    arr.push(cur.toISOString().split('T')[0]);
    cur.setDate(cur.getDate()+1);
  }
  return arr;
}
function weekdayName(d){
  return d.toLocaleDateString('pt-PT',{weekday:'short'}).replace('.', '');
}
function formatDateShort(isoYmd){
  const d = new Date(isoYmd);
  return d.toLocaleDateString('pt-PT');
}
function formatDisplayRange(a,b){
  return `${formatDateShort(a)} → ${formatDateShort(b)}`;
}
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* openSemana by id (reload doc) */
async function openSemanaById(semId){
  try{
    const snap = await getDoc(doc(db,'turmas',turmaAtiva.id,'semanas',semId));
    if(!snap.exists()){ alert('Semana não encontrada'); return; }
    const data = snap.data();
    openSemana({ id: semId, ...data });
  }catch(err){ console.error(err); alert('Erro abrir semana'); }
}

/* openSemana wrapper used by list items */
async function openSemana(semObj){
  // if semObj.planificacao available, directly render; otherwise fetch exists above (openSemana handles both)
  if(!semObj.planificacao){
    await openSemanaById(semObj.id);
    return;
  }
  // else semObj has planificacao already
  semanaAtiva = { id: semObj.id, inicio: semObj.inicio, fim: semObj.fim, rangeText: semObj.rangeText, horarios: semObj.horarios || HORARIOS, planificacao: semObj.planificacao };
  tituloSemana.textContent = `Planificação — ${turmaAtiva.nome}`;
  subtituloSemana.textContent = semObj.rangeText || (semObj.inicio + ' → ' + semObj.fim);
  fillSelectDays(semObj.inicio, semObj.fim);
  renderGrid(semObj.inicio, semObj.fim, semObj.planificacao || {});
  areaPlan.style.display = 'block';
}

/* loadSemanas shortcut button */
btnCarregarSemanas.addEventListener('click', loadSemanas);

/* ====== Inicial ====== */
function init(){
  // nothing else for now
}
init();

</script>
</body>
</html>
