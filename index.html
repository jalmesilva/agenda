<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planifica√ß√£o Semanal - 1¬∫ Ciclo</title>
    
    <!-- Firebase SDKs - Vers√£o mais est√°vel -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%) !important;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%) !important;
        }

        .view-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .view-controls button {
            width: auto;
            padding: 8px 16px;
            font-size: 12px;
        }

        .schedule-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .schedule-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .schedule-table th,
        .schedule-table td {
            border: 1px solid #ddd;
            text-align: center;
            vertical-align: top;
            position: relative;
        }

        .schedule-table th {
            background: #f8f9fa;
            font-weight: 600;
            padding: 15px 8px;
            color: #555;
        }

        .time-cell {
            background: #667eea !important;
            color: white !important;
            font-weight: 600;
            width: 120px;
            font-size: 12px;
            padding: 15px 10px;
        }

        .content-cell {
            height: 120px;
            width: 200px;
            padding: 5px;
        }

        .content-cell textarea {
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            font-size: 10px;
            line-height: 1.2;
            padding: 5px;
            background: transparent;
        }

        .content-cell textarea:focus {
            outline: 2px solid #667eea;
            background: #f0f7ff;
        }

        .turma-list {
            list-style: none;
        }

        .turma-item {
            background: #f8f9fa;
            margin: 8px 0;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .turma-info {
            flex: 1;
        }

        .turma-actions {
            display: flex;
            gap: 8px;
        }

        .turma-actions button {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
        }

        .semana-list {
            list-style: none;
        }

        .semana-item {
            background: #f8f9fa;
            margin: 8px 0;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #36d1dc;
        }

        .semana-actions {
            display: flex;
            gap: 8px;
        }

        .semana-actions button {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
        }

        .hidden {
            display: none !important;
        }

        .active-day {
            background: #e8f4f8 !important;
        }

        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .auth-card h2 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 10px;
            overflow: hidden;
            background: #f0f0f0;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .auth-tab.active {
            background: #667eea;
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .error-message {
            color: #ff4444;
            margin: 10px 0;
            padding: 10px;
            background: #ffe6e6;
            border-radius: 5px;
            font-size: 14px;
        }

        .success-message {
            color: #00aa00;
            margin: 10px 0;
            padding: 10px;
            background: #e6ffe6;
            border-radius: 5px;
            font-size: 14px;
        }

        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2) !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
            color: white !important;
            padding: 8px 16px !important;
            font-size: 12px !important;
            width: auto !important;
        }

        .main-content {
            display: none;
        }

        .main-content.active {
            display: block;
        }

        .container {
            padding: 10px;
        }

        .header h1 {
            font-size: 1.8em;
        }

        .schedule-table {
            font-size: 9px;
        }

        .content-cell {
            height: 80px;
            width: 150px;
        }

        .content-cell textarea {
            font-size: 9px;
        }
    </style>
</head>
<body>
    <!-- Tela de Autentica√ß√£o -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <h2>üéì Planifica√ß√£o Escolar</h2>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="mostrarForm('login')">Entrar</button>
                <button class="auth-tab" onclick="mostrarForm('register')">Registar</button>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>

            <!-- Formul√°rio de Login -->
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <input type="email" id="loginEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="Palavra-passe" required>
                </div>
                <button type="submit">Entrar</button>
            </form>

            <!-- Formul√°rio de Registo -->
            <form id="registerForm" class="auth-form">
                <div class="form-group">
                    <input type="text" id="registerName" placeholder="Nome completo" required>
                </div>
                <div class="form-group">
                    <input type="email" id="registerEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="registerPassword" placeholder="Palavra-passe (min. 6 caracteres)" required>
                </div>
                <button type="submit">Registar</button>
            </form>
        </div>
    </div>

    <!-- Conte√∫do Principal -->
    <div id="mainContent" class="main-content">
        <div class="container">
            <div class="header">
                <div class="user-info">
                    <div>
                        <h1>Planifica√ß√£o Semanal</h1>
                        <p>Bem-vindo, <span id="userName"></span>!</p>
                    </div>
                    <button onclick="logout()" class="logout-btn">üö™ Sair</button>
                </div>
                <p>Sistema de Planifica√ß√£o para Professores do 1¬∫ Ciclo</p>
            </div>

            <div class="controls">
                <!-- Criar Turma -->
                <div class="card">
                    <h3>üìö Criar Nova Turma</h3>
                    <div class="form-group">
                        <label>Nome da Turma:</label>
                        <input type="text" id="nomeTurma" placeholder="Ex: 4¬∫ ano">
                    </div>
                    <div class="form-group">
                        <label>Ano Letivo:</label>
                        <input type="text" id="anoLetivo" placeholder="Ex: 2024/2025">
                    </div>
                    <div class="form-group">
                        <label>Professor(a):</label>
                        <input type="text" id="nomeProfessor" placeholder="Nome do professor">
                    </div>
                    <button id="btnCriarTurma">Criar Turma</button>
                </div>

                <!-- Lista de Turmas -->
                <div class="card">
                    <h3>üìã Turmas Criadas</h3>
                    <ul id="listaTurmas" class="turma-list"></ul>
                </div>

                <!-- Definir Semana com Calend√°rio -->
                <div class="card" id="cardSemana" style="display: none;">
                    <h3>üìÖ Definir Semana de Planifica√ß√£o</h3>
                    
                    <!-- Semanas R√°pidas -->
                    <div class="quick-weeks">
                        <button class="quick-week-btn" onclick="criarSemanaRapida('esta')">üìÖ Esta Semana</button>
                        <button class="quick-week-btn" onclick="criarSemanaRapida('proxima')">‚è≠Ô∏è Pr√≥xima Semana</button>
                        <button class="quick-week-btn" onclick="criarSemanaRapida('custom')">üóìÔ∏è Escolher no Calend√°rio</button>
                    </div>

                    <!-- Calend√°rio -->
                    <div id="calendarContainer" class="calendar-container" style="display: none;">
                        <div class="calendar-header">
                            <h4 id="calendarTitle">Selecione a Semana</h4>
                            <div class="calendar-nav">
                                <button onclick="changeMonth(-1)">‚Äπ</button>
                                <button onclick="changeMonth(1)">‚Ä∫</button>
                            </div>
                        </div>
                        
                        <div class="calendar-grid">
                            <div class="calendar-day-header">Dom</div>
                            <div class="calendar-day-header">Seg</div>
                            <div class="calendar-day-header">Ter</div>
                            <div class="calendar-day-header">Qua</div>
                            <div class="calendar-day-header">Qui</div>
                            <div class="calendar-day-header">Sex</div>
                            <div class="calendar-day-header">S√°b</div>
                            <!-- Dias ser√£o adicionados dinamicamente -->
                        </div>
                    </div>

                    <!-- Semana Selecionada -->
                    <div id="selectedWeek" class="selected-range" style="display: none;">
                        <h4>Semana Selecionada:</h4>
                        <p id="weekRangeText"></p>
                        <button onclick="confirmarSemana()" style="margin-top: 10px;">‚úÖ Criar Esta Semana</button>
                    </div>

                    <!-- Lista de Semanas Existentes -->
                    <div style="margin-top: 30px;">
                        <h4>üìã Semanas Criadas</h4>
                        <ul id="listaSemanas" class="semana-list"></ul>
                    </div>
                </div>
            </div>

            <!-- √Årea da Planifica√ß√£o -->
            <div id="areaPlanificacao" style="display: none;">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h3 id="tituloAtual">Planifica√ß√£o Ativa</h3>
                            <p id="infoAtual" style="color: #666; margin-top: 5px;"></p>
                        </div>
                        <div class="view-controls">
                            <button onclick="mostrarSemanaCompleta()">üìÖ Semana Completa</button>
                            <button onclick="mostrarDia('segunda')">2¬™ feira</button>
                            <button onclick="mostrarDia('terca')">3¬™ feira</button>
                            <button onclick="mostrarDia('quarta')">4¬™ feira</button>
                            <button onclick="mostrarDia('quinta')">5¬™ feira</button>
                            <button onclick="mostrarDia('sexta')">6¬™ feira</button>
                            <button onclick="salvarPlanificacao()" class="btn-secondary">üíæ Salvar</button>
                        </div>
                    </div>

                    <div class="schedule-container">
                        <div class="schedule-header">
                            <h4 id="cabecalhoPlanificacao">Planifica√ß√£o Semanal</h4>
                        </div>
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>Horas</th>
                                    <th class="day-header" data-day="segunda">2¬™ feira</th>
                                    <th class="day-header" data-day="terca">3¬™ feira</th>
                                    <th class="day-header" data-day="quarta">4¬™ feira</th>
                                    <th class="day-header" data-day="quinta">5¬™ feira</th>
                                    <th class="day-header" data-day="sexta">6¬™ feira</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="time-cell">9h00‚Äì10h30</td>
                                    <td class="content-cell day-cell" data-day="segunda" data-time="0900-1030">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="terca" data-time="0900-1030">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="quarta" data-time="0900-1030">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="quinta" data-time="0900-1030">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="sexta" data-time="0900-1030">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="time-cell">11h00‚Äì12h30</td>
                                    <td class="content-cell day-cell" data-day="segunda" data-time="1100-1230">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="terca" data-time="1100-1230">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="quarta" data-time="1100-1230">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="quinta" data-time="1100-1230">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="sexta" data-time="1100-1230">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="time-cell">13h45‚Äì15h30</td>
                                    <td class="content-cell day-cell" data-day="segunda" data-time="1345-1530">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="terca" data-time="1345-1530">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="quarta" data-time="1345-1530">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="quinta" data-time="1345-1530">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="sexta" data-time="1345-1530">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="time-cell">16h00‚Äì17h15</td>
                                    <td class="content-cell day-cell" data-day="segunda" data-time="1600-1715">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="terca" data-time="1600-1715">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="quarta" data-time="1600-1715">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="quinta" data-time="1600-1715">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                    <td class="content-cell day-cell" data-day="sexta" data-time="1600-1715">
                                        <textarea placeholder="Planifica√ß√£o..."></textarea>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAC9EguGeZd50W1jADEx73aJKGacFeGk9o",
            authDomain: "bddespesas.firebaseapp.com",
            projectId: "bddespesas",
            storageBucket: "bddespesas.firebasestorage.app",
            messagingSenderId: "521648200265",
            appId: "1:521648200265:web:82fc2c97f02e185478fd98",
            measurementId: "G-P7NX1T9RVE"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let turmaAtiva = null;
        let semanaAtiva = null;
        let calendarDate = new Date();
        let selectedWeekStart = null;
        let selectedWeekEnd = null;

        // Verificar estado de autentica√ß√£o
        auth.onAuthStateChanged(function(user) {
            console.log('Estado de autentica√ß√£o mudou:', user);
            if (user) {
                currentUser = user;
                document.getElementById('userName').textContent = user.displayName || user.email;
                mostrarConteudoPrincipal();
                carregarTurmas();
            } else {
                currentUser = null;
                mostrarTelaAuth();
            }
        });

        function mostrarTelaAuth() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('mainContent').classList.remove('active');
        }

        function mostrarConteudoPrincipal() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContent').classList.add('active');
        }

        function mostrarForm(tipo) {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            document.getElementById(tipo + 'Form').classList.add('active');
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function mostrarErro(mensagem) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = mensagem;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        function mostrarSucesso(mensagem) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = mensagem;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            console.log('Tentativa de login com:', email);
            if (!email || !password) {
                mostrarErro('Por favor, preencha todos os campos.');
                return;
            }

            const submitBtn = e.target.querySelector('button');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'A entrar...';
            submitBtn.disabled = true;

            auth.signInWithEmailAndPassword(email, password)
                .then(function(userCredential) {
                    console.log('Login bem-sucedido:', userCredential.user);
                    mostrarSucesso('Login realizado com sucesso!');
                })
                .catch(function(error) {
                    console.error('Erro no login:', error);
                    let mensagem = 'Erro no login. Verifique os seus dados.';
                    switch(error.code) {
                        case 'auth/user-not-found':
                            mensagem = 'Utilizador n√£o encontrado.';
                            break;
                        case 'auth/wrong-password':
                            mensagem = 'Palavra-passe incorreta.';
                            break;
                        case 'auth/invalid-email':
                            mensagem = 'Email inv√°lido.';
                            break;
                        case 'auth/user-disabled':
                            mensagem = 'Esta conta foi desativada.';
                            break;
                        case 'auth/too-many-requests':
                            mensagem = 'Muitas tentativas. Tente novamente mais tarde.';
                            break;
                        default:
                            mensagem = `Erro: ${error.message}`;
                    }
                    mostrarErro(mensagem);
                })
                .finally(function() {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
        });

        // Registo
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();

            console.log('Tentativa de registo com:', email);
            if (!name || !email || !password) {
                mostrarErro('Por favor, preencha todos os campos.');
                return;
            }

            if (password.length < 6) {
                mostrarErro('A palavra-passe deve ter pelo menos 6 caracteres.');
                return;
            }

            const submitBtn = e.target.querySelector('button');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'A registar...';
            submitBtn.disabled = true;

            auth.createUserWithEmailAndPassword(email, password)
                .then(function(userCredential) {
                    console.log('Registo bem-sucedido:', userCredential.user);
                    return userCredential.user.updateProfile({
                        displayName: name
                    });
                })
                .then(function() {
                    mostrarSucesso('Conta criada com sucesso! A iniciar sess√£o...');
                    document.getElementById('registerName').value = '';
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                })
                .catch(function(error) {
                    console.error('Erro no registo:', error);
                    let mensagem = 'Erro ao criar conta.';
                    switch(error.code) {
                        case 'auth/email-already-in-use':
                            mensagem = 'Este email j√° est√° a ser usado.';
                            break;
                        case 'auth/invalid-email':
                            mensagem = 'Email inv√°lido.';
                            break;
                        case 'auth/weak-password':
                            mensagem = 'Palavra-passe muito fraca.';
                            break;
                        case 'auth/operation-not-allowed':
                            mensagem = 'Registo n√£o permitido. Contacte o administrador.';
                            break;
                        default:
                            mensagem = `Erro: ${error.message}`;
                    }
                    mostrarErro(mensagem);
                })
                .finally(function() {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
        });

        // Logout
        function logout() {
            if (confirm('Tem a certeza que deseja sair?')) {
                auth.signOut();
            }
        }

        // Criar turma
        document.getElementById('btnCriarTurma').addEventListener('click', async function() {
            const nome = document.getElementById('nomeTurma').value.trim();
            const ano = document.getElementById('anoLetivo').value.trim();
            const professor = document.getElementById('nomeProfessor').value.trim();

            if (!nome || !ano || !professor) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            try {
                await db.collection('turmas').add({
                    userId: currentUser.uid,
                    nome,
                    ano,
                    professor,
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('nomeTurma').value = '';
                document.getElementById('anoLetivo').value = '';
                document.getElementById('nomeProfessor').value = '';

                carregarTurmas();
                alert('Turma criada com sucesso!');
            } catch (error) {
                console.error('Erro ao criar turma:', error);
                alert('Erro ao criar turma: ' + error.message);
            }
        });

        // Carregar lista de turmas
        async function carregarTurmas() {
            const lista = document.getElementById('listaTurmas');
            lista.innerHTML = '';

            try {
                const snapshot = await db.collection('turmas')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('criadoEm', 'desc')
                    .get();

                if (snapshot.empty) {
                    lista.innerHTML = '<li style="text-align: center; color: #999; font-style: italic;">Nenhuma turma criada</li>';
                    return;
                }

                snapshot.forEach(doc => {
                    const turma = { id: doc.id, ...doc.data() };
                    const li = document.createElement('li');
                    li.className = 'turma-item';
                    li.innerHTML = `
                        <div class="turma-info">
                            <strong>${turma.nome}</strong><br>
                            <small>${turma.ano} ‚Ä¢ ${turma.professor}</small>
                        </div>
                        <div class="turma-actions">
                            <button onclick="selecionarTurma('${turma.id}', '${turma.nome}', '${turma.ano}', '${turma.professor}')" class="btn-secondary">Selecionar</button>
                            <button onclick="eliminarTurma('${turma.id}')" class="btn-danger">Eliminar</button>
                        </div>
                    `;
                    lista.appendChild(li);
                });
            } catch (error) {
                console.error('Erro ao carregar turmas:', error);
                lista.innerHTML = '<li style="color: red;">Erro ao carregar turmas.</li>';
            }
        }

        // Selecionar turma
        function selecionarTurma(turmaId, nome, ano, professor) {
            console.log('Selecionando turma:', turmaId, nome, ano, professor);
            try {
                turmaAtiva = {
                    id: turmaId,
                    nome: nome,
                    ano: ano,
                    professor: professor
                };
                
                console.log('Turma ativa definida:', turmaAtiva);
                document.getElementById('cardSemana').style.display = 'block';
                carregarSemanas();
                alert(`Turma "${nome}" selecionada!`);
            } catch (error) {
                console.error('Erro ao selecionar turma:', error);
                alert('Erro ao selecionar turma: ' + error.message);
            }
        }

        // Eliminar turma
        async function eliminarTurma(turmaId) {
            if (!confirm('Tem a certeza que deseja eliminar esta turma? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }

            try {
                const semanasSnapshot = await db.collection('semanas')
                    .where('turmaId', '==', turmaId)
                    .get();

                const batch = db.batch();
                semanasSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                batch.delete(db.collection('turmas').doc(turmaId));
                await batch.commit();

                carregarTurmas();

                if (turmaAtiva && turmaAtiva.id === turmaId) {
                    turmaAtiva = null;
                    semanaAtiva = null;
                    document.getElementById('cardSemana').style.display = 'none';
                    document.getElementById('areaPlanificacao').style.display = 'none';
                }

                alert('Turma eliminada com sucesso!');
            } catch (error) {
                console.error('Erro ao eliminar turma:', error);
                alert('Erro ao eliminar turma: ' + error.message);
            }
        }

        // Criar semana r√°pida
        function criarSemanaRapida(tipo) {
            const hoje = new Date();
            let startDate, endDate;

            if (tipo === 'esta') {
                const dayOfWeek = hoje.getDay();
                const monday = hoje.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                startDate = new Date(hoje.setDate(monday));
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 4);
            } else if (tipo === 'proxima') {
                const dayOfWeek = hoje.getDay();
                const monday = hoje.getDate() - dayOfWeek + (dayOfWeek === 0 ? 1 : 8);
                startDate = new Date(hoje.setDate(monday));
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 4);
            } else if (tipo === 'custom') {
                document.getElementById('calendarContainer').style.display = 'block';
                generateCalendar();
                return;
            }

            selectedWeekStart = startDate;
            selectedWeekEnd = endDate;
            mostrarSemanaSelcionada();
        }

        // Gerar calend√°rio
        function generateCalendar() {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            
            document.getElementById('calendarTitle').textContent = 
                new Intl.DateTimeFormat('pt-PT', { month: 'long', year: 'numeric' })
                    .format(calendarDate);

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const calendarGrid = document.querySelector('.calendar-grid');
            const existingDays = calendarGrid.querySelectorAll('.calendar-day');
            existingDays.forEach(day => day.remove());

            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (currentDate.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }

                if (isToday(currentDate)) {
                    dayElement.classList.add('today');
                }

                dayElement.innerHTML = `
                    <div class="day-number">${currentDate.getDate()}</div>
                `;

                dayElement.onclick = () => selectWeek(currentDate);
                calendarGrid.appendChild(dayElement);
            }
        }

        // Verificar se √© hoje
        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        // Selecionar semana
        function selectWeek(clickedDate) {
            const dayOfWeek = clickedDate.getDay();
            const monday = new Date(clickedDate);
            monday.setDate(clickedDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
            
            const friday = new Date(monday);
            friday.setDate(monday.getDate() + 4);

            selectedWeekStart = monday;
            selectedWeekEnd = friday;

            updateCalendarSelection();
            mostrarSemanaSelcionada();
        }

        // Atualizar sele√ß√£o visual do calend√°rio
        function updateCalendarSelection() {
            const days = document.querySelectorAll('.calendar-day');
            days.forEach(day => {
                day.classList.remove('selected', 'in-range', 'range-start', 'range-end');
            });

            if (selectedWeekStart && selectedWeekEnd) {
                days.forEach(day => {
                    const dayDate = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), 
                        parseInt(day.querySelector('.day-number').textContent));
                    
                    if (dayDate >= selectedWeekStart && dayDate <= selectedWeekEnd) {
                        day.classList.add('in-range');
                        if (dayDate.getTime() === selectedWeekStart.getTime()) {
                            day.classList.add('range-start');
                        }
                        if (dayDate.getTime() === selectedWeekEnd.getTime()) {
                            day.classList.add('range-end');
                        }
                    }
                });
            }
        }

        // Mostrar semana selecionada
        function mostrarSemanaSelcionada() {
            if (!selectedWeekStart || !selectedWeekEnd) return;

            const startStr = selectedWeekStart.toLocaleDateString('pt-PT');
            const endStr = selectedWeekEnd.toLocaleDateString('pt-PT');
            
            document.getElementById('weekRangeText').textContent = 
                `${startStr} a ${endStr} (Segunda a Sexta-feira)`;
            document.getElementById('selectedWeek').style.display = 'block';
        }

        // Confirmar cria√ß√£o da semana
        async function confirmarSemana() {
            if (!turmaAtiva || !selectedWeekStart || !selectedWeekEnd) {
                alert('Erro: dados incompletos.');
                return;
            }

            const startStr = selectedWeekStart.toLocaleDateString('pt-PT');
            const endStr = selectedWeekEnd.toLocaleDateString('pt-PT');
            const descricao = `${startStr} a ${endStr}`;

            try {
                console.log('A criar semana:', descricao, 'para turma:', turmaAtiva.id);
                await db.collection('semanas').add({
                    turmaId: turmaAtiva.id,
                    descricao: descricao,
                    dataInicio: firebase.firestore.Timestamp.fromDate(selectedWeekStart),
                    dataFim: firebase.firestore.Timestamp.fromDate(selectedWeekEnd),
                    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
                    planificacao: {}
                });

                selectedWeekStart = null;
                selectedWeekEnd = null;
                document.getElementById('selectedWeek').style.display = 'none';
                document.getElementById('calendarContainer').style.display = 'none';

                carregarSemanas();
                alert('Semana criada com sucesso!');
            } catch (error) {
                console.error('Erro ao criar semana:', error);
                if (error.code === 'permission-denied') {
                    alert('Erro de permiss√µes. Verifique as regras do Firestore:\n\n' +
                          '1. V√° ao Firebase Console\n' +
                          '2. Firestore Database ‚Üí Rules\n' +
                          '3. Use regras de teste:\n\n' +
                          'allow read, write: if request.auth != null;');
                } else {
                    alert('Erro ao criar semana: ' + error.message);
                }
            }
        }

        // Editar semana
        function editarSemana(semanaId, descricao, dataInicio, dataFim) {
            selectedWeekStart = new Date(dataInicio);
            selectedWeekEnd = new Date(dataFim);
            
            document.getElementById('calendarContainer').style.display = 'block';
            generateCalendar();
            mostrarSemanaSelcionada();
            
            const confirmarBtn = document.getElementById('selectedWeek').querySelector('button');
            confirmarBtn.textContent = '‚úÖ Atualizar Semana';
            confirmarBtn.onclick = async () => {
                if (!turmaAtiva || !selectedWeekStart || !selectedWeekEnd) {
                    alert('Erro: dados incompletos.');
                    return;
                }

                const startStr = selectedWeekStart.toLocaleDateString('pt-PT');
                const endStr = selectedWeekEnd.toLocaleDateString('pt-PT');
                const novaDescricao = `${startStr} a ${endStr}`;

                try {
                    await db.collection('semanas').doc(semanaId).update({
                        descricao: novaDescricao,
                        dataInicio: firebase.firestore.Timestamp.fromDate(selectedWeekStart),
                        dataFim: firebase.firestore.Timestamp.fromDate(selectedWeekEnd),
                        atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    selectedWeekStart = null;
                    selectedWeekEnd = null;
                    document.getElementById('selectedWeek').style.display = 'none';
                    document.getElementById('calendarContainer').style.display = 'none';

                    carregarSemanas();
                    alert('Semana atualizada com sucesso!');
                    
                    confirmarBtn.textContent = '‚úÖ Criar Esta Semana';
                    confirmarBtn.onclick = confirmarSemana;
                } catch (error) {
                    console.error('Erro ao atualizar semana:', error);
                    alert('Erro ao atualizar semana: ' + error.message);
                }
            };
        }

        // Navegar meses do calend√°rio
        function changeMonth(direction) {
            calendarDate.setMonth(calendarDate.getMonth() + direction);
            generateCalendar();
        }

        // Carregar semanas
        async function carregarSemanas() {
            const lista = document.getElementById('listaSemanas');
            
            if (!turmaAtiva) {
                lista.innerHTML = '<li style="text-align: center; color: #999; font-style: italic;">Selecione uma turma primeiro</li>';
                return;
            }

            try {
                console.log('A carregar semanas para a turma:', turmaAtiva.id);
                const snapshot = await db.collection('semanas')
                    .where('turmaId', '==', turmaAtiva.id)
                    .orderBy('criadoEm', 'desc')
                    .get();

                console.log('Semanas encontradas:', snapshot.size);
                lista.innerHTML = '';

                if (snapshot.empty) {
                    lista.innerHTML = '<li style="text-align: center; color: #999; font-style: italic;">Nenhuma semana criada</li>';
                    return;
                }

                const semanas = [];
                snapshot.forEach((doc) => {
                    const semanaData = { id: doc.id, ...doc.data() };
                    semanas.push(semanaData);
                    console.log('Semana carregada:', semanaData);
                });

                semanas.forEach((semana) => {
                    const li = document.createElement('li');
                    li.className = 'semana-item';
                    li.innerHTML = `
                        <div>
                            <strong>${semana.descricao}</strong>
                        </div>
                        <div class="semana-actions">
                            <button onclick="abrirPlanificacao('${semana.id}', '${semana.descricao}')" class="btn-secondary">Abrir</button>
                            <button onclick="editarSemana('${semana.id}', '${semana.descricao}', '${semana.dataInicio.toDate().toISOString()}', '${semana.dataFim.toDate().toISOString()}')" class="btn-secondary">Editar</button>
                            <button onclick="eliminarSemana('${semana.id}')" class="btn-danger">Eliminar</button>
                        </div>
                    `;
                    lista.appendChild(li);
                });
            } catch (error) {
                console.error('Erro ao carregar semanas:', error);
                lista.innerHTML = '<li style="color: red;">Erro ao carregar semanas. Pode precisar criar √≠ndice no Firestore.</li>';
                if (error.code === 'failed-precondition') {
                    console.log('Precisa criar um √≠ndice no Firestore. Clique no link que apareceu no console.');
                }
            }
        }

        // Abrir planifica√ß√£o
        function abrirPlanificacao(semanaId, descricao) {
            if (!turmaAtiva) return;

            semanaAtiva = { id: semanaId, descricao: descricao };
            document.getElementById('tituloAtual').textContent = `Planifica√ß√£o: ${descricao}`;
            document.getElementById('infoAtual').textContent = `${turmaAtiva.nome} ‚Ä¢ ${turmaAtiva.ano} ‚Ä¢ ${turmaAtiva.professor}`;
            document.getElementById('cabecalhoPlanificacao').textContent = `${turmaAtiva.nome} | ${turmaAtiva.ano} | ${turmaAtiva.professor} | SEMANA: ${descricao}`;

            carregarDadosPlanificacao();
            document.getElementById('areaPlanificacao').style.display = 'block';
            mostrarSemanaCompleta();
            document.getElementById('areaPlanificacao').scrollIntoView({ behavior: 'smooth' });
        }

        // Eliminar semana
        async function eliminarSemana(semanaId) {
            if (!confirm('Tem a certeza que deseja eliminar esta semana? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }

            try {
                await db.collection('semanas').doc(semanaId).delete();
                carregarSemanas();

                if (semanaAtiva && semanaAtiva.id === semanaId) {
                    semanaAtiva = null;
                    document.getElementById('areaPlanificacao').style.display = 'none';
                }

                alert('Semana eliminada com sucesso!');
            } catch (error) {
                console.error('Erro ao eliminar semana:', error);
                alert('Erro ao eliminar semana: ' + error.message);
            }
        }

        // Carregar dados da planifica√ß√£o
        async function carregarDadosPlanificacao() {
            if (!turmaAtiva || !semanaAtiva) return;

            try {
                const doc = await db.collection('semanas').doc(semanaAtiva.id).get();
                if (!doc.exists) return;

                const planificacao = doc.data().planificacao || {};
                const textareas = document.querySelectorAll('.content-cell textarea');
                textareas.forEach(textarea => {
                    const cell = textarea.closest('.content-cell');
                    const day = cell.getAttribute('data-day');
                    const time = cell.getAttribute('data-time');
                    const key = `${day}-${time}`;
                    textarea.value = planificacao[key] || '';
                });
            } catch (error) {
                console.error('Erro ao carregar planifica√ß√£o:', error);
            }
        }

        // Salvar planifica√ß√£o
        async function salvarPlanificacao() {
            if (!turmaAtiva || !semanaAtiva) {
                alert('Selecione uma turma e semana primeiro.');
                return;
            }

            try {
                const planificacao = {};
                const textareas = document.querySelectorAll('.content-cell textarea');
                textareas.forEach(textarea => {
                    const cell = textarea.closest('.content-cell');
                    const day = cell.getAttribute('data-day');
                    const time = cell.getAttribute('data-time');
                    const key = `${day}-${time}`;
                    planificacao[key] = textarea.value;
                });

                await db.collection('semanas').doc(semanaAtiva.id).update({
                    planificacao: planificacao,
                    atualizadoEm: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Planifica√ß√£o guardada com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar planifica√ß√£o:', error);
                alert('Erro ao guardar planifica√ß√£o: ' + error.message);
            }
        }

        // Mostrar semana completa
        function mostrarSemanaCompleta() {
            const headers = document.querySelectorAll('.day-header');
            const cells = document.querySelectorAll('.day-cell');

            headers.forEach(header => {
                header.classList.remove('hidden');
                header.classList.remove('active-day');
            });

            cells.forEach(cell => {
                cell.classList.remove('hidden');
                cell.classList.remove('active-day');
            });
        }

        // Mostrar apenas um dia
        function mostrarDia(dia) {
            const headers = document.querySelectorAll('.day-header');
            const cells = document.querySelectorAll('.day-cell');

            headers.forEach(header => {
                if (header.getAttribute('data-day') === dia) {
                    header.classList.remove('hidden');
                    header.classList.add('active-day');
                } else {
                    header.classList.add('hidden');
                    header.classList.remove('active-day');
                }
            });

            cells.forEach(cell => {
                if (cell.getAttribute('data-day') === dia) {
                    cell.classList.remove('hidden');
                    cell.classList.add('active-day');
                } else {
                    cell.classList.add('hidden');
                    cell.classList.remove('active-day');
                }
            });
        }

        // Auto-save ao digitar
        document.addEventListener('input', function(e) {
            if (e.target.tagName === 'TEXTAREA' && e.target.closest('.content-cell')) {
                clearTimeout(e.target.autoSaveTimer);
                e.target.autoSaveTimer = setTimeout(() => {
                    salvarPlanificacao();
                }, 3000);
            }
        });
    </script>
</body>
</html>
